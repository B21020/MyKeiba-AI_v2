## 2026/02/08 レポート（評価歪み修正 + 単勝EV化の検証）

### 1. 目的
1) 学習・評価の歪み（リーク/重複）を除去し、回収率評価を「現実的な水準」で測れる状態に戻す。  
2) 単勝から EV（期待値）ベースの購入条件を導入し、margin sweep で回収率カーブを確認する。

---

### 2. 発生していた問題（原因と影響）

#### 2.1 fold=6 のAUCが異常に高い（評価が楽観）
- **原因**: 同日データが学習/検証に跨る形で混入し、「同日リーク」になっていた。
- **影響**: 特定foldだけ異常に高いAUCが出て、モデルの実力を誤認する。

#### 2.2 OOS回収率が 1 を大きく超える（非現実）
- **原因**: 払戻テーブルに「完全に同一の行」が重複して入っており、さらに Simulator が同一 `race_id` を合算してしまい、払戻が多重計上されていた。
- **影響**: 実運用では起こり得ない水準の回収率が出ていた（評価指標として破綻）。

---

### 3. 実施した修正（コード変更の要点）

#### 3.1 「同日リーク」対策（評価の健全化）
- **方針**: レース単位（`race_id`）で代表日付を取り、時系列順に train/test を切る。さらに馬の過去成績集約は「対象日より過去」に限定して特徴量を作る。
- **補助**: ローリング時系列評価を行うためのユーティリティを追加。
	- 追加: [modules/training/_rolling_auc.py](modules/training/_rolling_auc.py)
	- 目的: foldごとの時系列AUCと、test内の「1レースあたり行数」分布（重複混入の兆候）を同時に監視。

#### 3.2 払戻テーブル重複による回収率過大の修正
- **修正1（下流での安全弁）**: ReturnProcessor で「同一 `race_id` 内の完全重複行」を除去。
	- 変更: [modules/preprocessing/_return_processor.py](modules/preprocessing/_return_processor.py)
	- 追加: `ReturnProcessor._drop_exact_duplicate_rows_per_race(df)`
	- 適用: 単勝/複勝/馬連/馬単/ワイド/三連単/三連複の各テーブル生成後に適用

- **修正2（rawの恒久対処）**: `data/raw/return_tables.pickle` 自体の「完全重複」を除去するスクリプトを追加。
	- 追加: [tools/dedup_return_tables_raw.py](tools/dedup_return_tables_raw.py)
	- 動作: index（race_id）を含めて重複判定し、バックアップを作成したうえで dedup。

#### 3.3 EV（期待値）単勝ポリシーの実装
- 追加: [modules/policies/_bet_policy.py](modules/policies/_bet_policy.py)
	- `BetPolicyEVTansho`
	- **購入条件**: $EV = score \times odds$、$EV \ge 1 + margin$ の馬を購入
	- オッズの与え方:
		- `score_table` にオッズ列が無い場合、`tansho_odds`（Series）を index-align して注入
	- 任意制約:
		- `max_bets_per_race`: レースごとにEV上位K頭まで
		- `min_odds`: 最低オッズを満たす馬のみ

#### 3.4 Notebook不安定を迂回する EV sweep スクリプト
- 追加: [tools/run_ev_tansho_sweep.py](tools/run_ev_tansho_sweep.py)
- 目的: Notebookのモジュールキャッシュ/実行順依存が不安定でも、EV margin sweep を確実に完走し pickle を生成する。

---

### 4. EV化（単勝）の検証方法

#### 4.1 使用したデータ/構成
- モデル: `models/20260208/basemodel_2020_2026.pickle`
- 対象: `keiba_ai.datasets.X_test`（テスト期間）
- オッズ: `keiba_ai.datasets.tansho_odds_test`
- 払戻: `ReturnProcessor(LocalPaths.RAW_RETURN_TABLES_PATH)` + `Simulator`

#### 4.2 sweep 条件
- `margin`: 0.0〜0.5（100分割、両端含む）
- 購入条件: $score \times odds \ge 1 + margin$
- 今回の sweep では購入点数制限なし（`max_bets_per_race=None`）

#### 4.3 出力
- 結果pickle: `models/20260208/tansho_ev_margin.pickle`
- プロット画像（作成済み）: `images/output_tansho.png`

---

### 5. EV単勝 sweep 結果（2026/02/08時点）

pickle（`models/20260208/tansho_ev_margin.pickle`）から読み取れる主要数値は以下。

#### 5.1 全体傾向
- `margin=0.0` 付近が最良で、`margin` を上げても回収率は改善しない（むしろ微減）。
- `margin` を上げるほど購入点数（`n_bets`）は減少。

#### 5.2 端点の比較
- `margin=0.0`
	- `return_rate` = 0.782071
	- `n_bets` = 40800
	- `n_races` = 11140
	- `n_hits` = 3447
	- `std` = 0.020595

- `margin=0.5`
	- `return_rate` = 0.774273
	- `n_bets` = 38189
	- `n_races` = 11049
	- `n_hits` = 2993
	- `std` = 0.021639

#### 5.3 return_rate 上位（参考: Top10）
1) `margin=0.000000`: return_rate 0.782071（n_bets 40800）  
2) `margin=0.015152`: return_rate 0.781780（n_bets 40735）  
3) `margin=0.010101`: return_rate 0.781646（n_bets 40753）  
4) `margin=0.005051`: return_rate 0.781526（n_bets 40776）  
5) `margin=0.313131`: return_rate 0.781290（n_bets 39231）

---

### 6. 解釈（現時点の結論）

#### 6.1 EV戦略としての示唆
- 今回の定義（$EV = score \times odds$）では、**margin を上げても回収率は改善しなかった**。
- 直感的には、これは「score が確率として十分にキャリブレーションされていない」または「モデルの優位性がオッズに対して上回れていない」可能性を示唆する。

#### 6.2 回収率の水準について
- `return_rate` が 0.78 前後で推移しており、少なくとも「重複で 1 を超える」状態ではない（評価の破綻は解消済み）。
- 一方で、単勝EVでプラス期待値（>1）を作れる段階にはまだ到達していない。

---

### 7. 次にやると効果が高いこと（最小の追加検証）

1) **購入点数を現実寄りに制限した再sweep**
	 - 例: `--max-bets-per-race 1`（各レース1点）
	 - 例: `--min-odds 3.0`（低オッズ過多を抑制）

2) **Notebookは可視化専用**
	 - `models/20260208/tansho_ev_margin.pickle` を読み込み、`return_rate ± std` を描画して比較を固定化する（計算はスクリプト側に寄せる）。

---

### 8. 付録（実行コマンド例）

- EV sweep（デフォルト）
	- `C:/Users/koxyg/Documents/GitHub/MyKeiba-AI_v2/.venv/Scripts/python.exe tools/run_ev_tansho_sweep.py`

- 各レース1点に制限して再sweep（例）
	- `C:/Users/koxyg/Documents/GitHub/MyKeiba-AI_v2/.venv/Scripts/python.exe tools/run_ev_tansho_sweep.py --max-bets-per-race 1`

- 最低オッズを設ける（例）
	- `C:/Users/koxyg/Documents/GitHub/MyKeiba-AI_v2/.venv/Scripts/python.exe tools/run_ev_tansho_sweep.py --min-odds 3.0`

